{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "config": { "view": { "stroke": null } },
  "params": [
    {
      "name": "Quarter",
      "value": "2021-22 Q4 (Jun Qtr)",
      "bind": {
        "input": "select",
        "options": [
          "2021-22 Q4 (Jun Qtr)",
          "2022-23 Q1 (Sep Qtr)",
          "2022-23 Q2 (Dec Qtr)",
          "2022-23 Q3 (Mar Qtr)",
          "2022-23 Q4 (Jun Qtr)",
          "2023-24 Q1 (Sep Qtr)",
          "2023-24 Q2 (Dec Qtr)",
          "2023-24 Q3 (Mar Qtr)",
          "2023-24 Q4 (Jun Qtr)",
          "2024-25 Q1 (Sep Qtr)",
          "2024-25 Q2 (Dec Qtr)"
        ]
      }
    }
  ],
  "vconcat": [
    {
      "title": "Population by state— Australia",
      "width": 500,
      "height": 500,
      "projection": { "type": "equirectangular" },
      "data": {
        "url": "https://raw.githubusercontent.com/gabriellapywong/FIT3179-DV-HW10/main/js/au_states_3.json",
        "format": { "type": "topojson", "feature": "STE_2021_AUST_GDA2020" }
      },
      "transform": [
        {
          "lookup": "properties.STE_NAME21",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/gabriellapywong/FIT3179-DV-HW10/main/data/population_1.csv",
              "format": { "type": "csv" }
            },
            "key": "State",
            "fields": [
              "2021-22 Q4 (Jun Qtr)",
              "2022-23 Q1 (Sep Qtr)",
              "2022-23 Q2 (Dec Qtr)",
              "2022-23 Q3 (Mar Qtr)",
              "2022-23 Q4 (Jun Qtr)",
              "2023-24 Q1 (Sep Qtr)",
              "2023-24 Q2 (Dec Qtr)",
              "2023-24 Q3 (Mar Qtr)",
              "2023-24 Q4 (Jun Qtr)",
              "2024-25 Q1 (Sep Qtr)",
              "2024-25 Q2 (Dec Qtr)"
            ]
          }
        },
        { "calculate": "toNumber(datum[Quarter])", "as": "Pop_num" }
      ],
      "mark": { "type": "geoshape", "stroke": "#555", "strokeWidth": 0.6 },
      "encoding": {
        "color": {
          "field": "Pop_num",
          "type": "quantitative",
          "scale": { "type": "linear", "scheme": "blues" },
          "title": "Population"
        },
        "tooltip": [
          { "field": "properties.STE_NAME21", "type": "nominal", "title": "State" },
          { "field": "Pop_num", "type": "quantitative", "title": "Population", "format": "," }
        ]
      }
    },
    {
      "title": "Medicare Benefits (A$) by Service — grouped by State",
      "width": 980,
      "height": 440,
      "data": {
        "url": "https://raw.githubusercontent.com/gabriellapywong/FIT3179-DV-HW10/main/data/all_service_cleaned.csv",
        "format": { "type": "csv" }
      },
      "transform": [
        { "filter": "datum.State != 'Australia' && datum.State != 'Unk'" },
        { "filter": "datum.Quarter === Quarter" },
        {
          "filter": "indexof(['Total GP Non-Referred Attendances','Specialist Attendances','Diagnostic Imaging','Pathology','Anaesthetics','Optometry','Practice Nurse','Other Allied Health','Other MBS Services','Radiotherapy and Therapeutic Nuclear Medicine'], datum['Broad Type of Service']) >= 0"
        },
        { "calculate": "toNumber(datum.Benefits)", "as": "Benefits_num" }
      ],
      "layer": [
        {
          "params": [
            {
              "name": "svcLegend1",
              "select": { "type": "point", "fields": ["Broad Type of Service"] },
              "bind": "legend"
            }
          ],
          "mark": { "type": "bar" },
          "encoding": {
            "x": { "field": "State", "type": "nominal", "sort": "-y", "title": null, "axis": { "labelAngle": 0 } },
            "xOffset": { "field": "Broad Type of Service" },
            "y": { "field": "Benefits_num", "type": "quantitative", "title": "Benefits (A$)", "axis": { "format": "~s" } },
            "color": {
              "field": "Broad Type of Service",
              "type": "nominal",
              "legend": { "title": "Service (click to filter)" }
            },
            "opacity": { "condition": { "param": "svcLegend1", "value": 1 }, "value": 0.25 },
            "tooltip": [
              { "field": "State", "title": "State" },
              { "field": "Broad Type of Service", "title": "Service" },
              { "field": "Benefits_num", "title": "Benefits (A$)", "format": "," }
            ],
            "order": { "field": "Benefits_num", "sort": "descending" }
          }
        },
        {
          "transform": [
            {
              "calculate": "datum['Broad Type of Service']=='Total GP Non-Referred Attendances' ? datum.Benefits_num : 0",
              "as": "gp_amount"
            },
            {
              "aggregate": [
                { "op": "sum", "field": "Benefits_num", "as": "stateTotal" },
                { "op": "sum", "field": "gp_amount", "as": "gpSum" }
              ],
              "groupby": ["State"]
            },
            { "calculate": "datum.gpSum / datum.stateTotal", "as": "gpShare" },
            { "aggregate": [ { "op": "mean", "field": "gpShare", "as": "avgGpShare" } ] },
            { "calculate": "'Avg GP share (states): ' + format(datum.avgGpShare, '.1%')", "as": "label" }
          ],
          "mark": { "type": "text", "align": "right", "fontSize": 12, "fontWeight": "bold", "fill": "#1f2937", "dx": -8, "dy": 0 },
          "encoding": {
            "x": { "value": 980 },
            "y": { "value": 18 },
            "text": { "field": "label" }
          }
        }
      ]
    }
  ]
}
